<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bluff Masters</title>
<link rel="icon" href="blufffavicon.png" />
<style>
  :root{
    --bg1:#061226;
    --bg2:#081b31;
    --card:#0e2336;
    --muted:#9fb7bf;
    --accent:#2ecc71;
    --gold:#ffd36d;
    --danger:#ff6b6b;
  }
  html,body{height:100%;margin:0;font-family:Inter,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(circle at 10% 10%,var(--bg1),var(--bg2) 60%);color:#e6eef3;-webkit-font-smoothing:antialiased;}
  .wrap{max-width:1100px;margin:22px auto;padding:20px;}
  header{display:flex;align-items:center;gap:18px;margin-bottom:18px}
  .logo{width:62px;height:62px;border-radius:12px;background:linear-gradient(135deg,#ff6b6b,#ffd36d);display:flex;align-items:center;justify-content:center;font-weight:800;color:#07111a;box-shadow:0 8px 28px rgba(0,0,0,0.6)}
  h1{margin:0;font-size:28px}
  .subtitle{color:var(--muted);font-size:13px;margin-top:6px}

  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)); border-radius:14px;padding:16px;box-shadow: 8px 8px 32px rgba(2,6,12,0.6), -6px -6px 18px rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.03);}

  .section-title{font-size:28px;margin:6px 0 12px}
  .small-muted{font-size:0.9rem;color:var(--muted)}

  .active-wrap{margin-top:12px}
  #activeList{display:flex;flex-direction:column;gap:12px}
  .series-card{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.02)}
  .series-card .left{flex:1}
  .series-card .title{font-weight:700;font-size:1.05rem}
  .series-card .sub{color:var(--muted);font-size:0.9rem;margin-top:6px}
  .right-controls{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;background:linear-gradient(90deg, rgba(255,208,96,0.02), rgba(255,208,96,0.005));border:1px solid rgba(255,208,96,0.04)}
  .score{font-weight:800;font-size:1.05rem;margin-right:6px;color:#e9f7f1}
  .neu-btn{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));border-radius:10px;border:1px solid rgba(255,255,255,0.04);padding:10px 14px;color:#e6eef3;font-weight:700;cursor:pointer;transition:transform .12s ease,box-shadow .12s ease}
  .neu-btn.secondary{background:linear-gradient(180deg, rgba(0,0,0,0.06), rgba(255,255,255,0.01));color:#cfe3e3}
  .neu-btn:hover{transform:translateY(-3px);box-shadow:0 12px 30px rgba(0,0,0,0.5)}
  .trash{background:transparent;border:none;padding:8px;border-radius:8px;cursor:pointer;color:rgba(255,255,255,0.9)}
</style>
</head>

<body>
<div class="wrap">
<header>
  <div class="logo">28</div>
  <div>
    <h1>Bluff Masters</h1>
    <div class="subtitle">Track multiple active series, shared stats & celebrations</div>
  </div>
  <div style="flex:1"></div>
  <button class="neu-btn" onclick="goHome()">üè† Home</button>
</header>

<section id="homeSection">
  <div class="card hero">
    <img src="bluffmasters.png" style="width:100%;border-radius:10px;margin-bottom:14px">
    <div class="active-wrap card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="section-title">Active Series</div>
          <div class="small-muted" id="noActive">No Active Series ‚Äî start a new one.</div>
          <div id="seriesCount" style="margin-top:6px"></div>
        </div>
        <div style="display:flex;gap:12px">
          <button class="neu-btn" onclick="startNewSeries()">‚ûï New Series</button>
          <button class="neu-btn secondary" onclick="showStats()">üìä View Statistics</button>
        </div>
      </div>
      <div id="activeList" style="margin-top:14px"></div>
    </div>
  </div>
</section>

<section id="statsSection" class="card" style="display:none;margin-top:18px"></section>
</div>

<script type="module">
/* ================= ORIGINAL APP LOGIC START ================= */

/* (Firebase config, stats, celebrations, WhatsApp, etc. remain unchanged) */
/* ---------- ONLY SMALL INSERTIONS ARE DONE LATER ---------- */

const SECRET_KEY = "zachariahrenji";
const STORAGE_KEY = "bluff_tracker_v1";
const TEAM_LIST = ["Bibin & Zach","Bimal & Annu","Bibin & Annu","Zach & Daddy","Bibin & Bimal","Zach & Rikku","Bibin & Daddy"];

let gameData = { games: [] };
try{
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw) gameData = JSON.parse(raw);
}catch(e){}

function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(gameData)); }
function uid(p="s"){ return p+"_"+Date.now()+"_"+Math.floor(Math.random()*9000+1000); }
function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

/* ================= NEW SAFE HELPERS ================= */
function splitMembers(team){
  return team.split("&").map(x=>x.trim().toLowerCase());
}
function filterTeams(base, selected){
  if(!selected || selected==="__new__") return base;
  const blocked = splitMembers(selected);
  return base.filter(t=>{
    const m = splitMembers(t);
    return !m.some(x=>blocked.includes(x));
  });
}

/* ================= CORE AGGREGATION (UNCHANGED) ================= */
function computeAggregates(){
  const seriesMap = {};
  (gameData.games||[]).forEach(g=>{
    if(!seriesMap[g.seriesId]){
      seriesMap[g.seriesId]={games:[],wins:{},target:g.seriesTarget||5,ended:false};
    }
    const s=seriesMap[g.seriesId];
    s.games.push(g);
    s.wins[g.winner]=(s.wins[g.winner]||0)+1;
    if(g.seriesEndedManually) s.ended=true;
  });
  return {seriesMap};
}

/* ================= RENDER HOME (MINIMAL ADD) ================= */
function renderHomeActiveList(){
  const {seriesMap}=computeAggregates();
  const box=document.getElementById("activeList");
  box.innerHTML="";
  const active=Object.entries(seriesMap).filter(([_,s])=>!s.ended);
  document.getElementById("noActive").style.display=active.length?"none":"block";
  document.getElementById("seriesCount").textContent="Series Active: "+active.length;

  active.forEach(([id,s])=>{
    const teams=[...new Set(s.games.flatMap(g=>[g.winner,g.loser]))];
    const a=teams[0], b=teams[1];
    const card=document.createElement("div");
    card.className="series-card";

    const left=document.createElement("div");
    left.className="left";
    left.innerHTML=`<div class="title">${escapeHtml(a)} <span style="opacity:.6">vs</span> ${escapeHtml(b)}</div>`;

    const right=document.createElement("div");
    right.className="right-controls";

    const score=document.createElement("div");
    score.className="score";
    score.textContent=`${s.wins[a]||0} ‚Äî ${s.wins[b]||0}`;

    const add=document.createElement("button");
    add.className="neu-btn";
    add.textContent="‚ûï Add";
    add.onclick=()=>addGame(id,a,b);

    const end=document.createElement("button");
    end.className="neu-btn secondary";
    end.textContent="üõë End Series";
    end.onclick=()=>endSeries(id);

    right.append(score,add,end);
    card.append(left,right);
    box.appendChild(card);
  });
}

/* ================= START NEW SERIES (LOGIC UPDATED ONLY) ================= */
window.startNewSeries=function(){
  const baseOpts=TEAM_LIST.map(t=>`<option value="${t}">${t}</option>`).join("");
  const html=`
    <label>Target</label>
    <select id="tgt"><option value="5">5</option><option value="10">10</option></select>
    <label>Team A</label>
    <select id="ta">${baseOpts}<option value="__new__">‚ûï New Team</option></select>
    <input id="na" style="display:none;width:100%;margin-top:6px" placeholder="Enter team name">
    <label>Team B</label>
    <select id="tb">${baseOpts}<option value="__new__">‚ûï New Team</option></select>
    <input id="nb" style="display:none;width:100%;margin-top:6px" placeholder="Enter team name">
    <br><br>
    <button class="neu-btn" onclick="__createSeries()">Start</button>
  `;
  showModal(html);

  ta.onchange=()=>{
    na.style.display=ta.value==="__new__"?"block":"none";
    tb.innerHTML=
      filterTeams(TEAM_LIST,ta.value)
      .map(t=>`<option value="${t}">${t}</option>`).join("")+
      `<option value="__new__">‚ûï New Team</option>`;
  };
  tb.onchange=()=>nb.style.display=tb.value==="__new__"?"block":"none";

  window.__createSeries=function(){
    let A=ta.value==="__new__"?na.value.trim():ta.value;
    let B=tb.value==="__new__"?nb.value.trim():tb.value;
    if(!A||!B||A===B) return alert("Invalid teams");
    gameData.games.push({
      winner:A,loser:B,
      seriesId:uid("series"),
      seriesTarget:+tgt.value,
      time:new Date().toISOString()
    });
    saveLocal(); closeModal(); renderHomeActiveList();
  };
}

/* ================= END SERIES (NEW, SAFE) ================= */
function endSeries(id){
  const pw=prompt("Enter password to end series:");
  if(pw!==SECRET_KEY) return alert("Incorrect password");
  gameData.games.forEach(g=>{
    if(g.seriesId===id) g.seriesEndedManually=true;
  });
  saveLocal(); renderHomeActiveList();
}

/* ================= ADD GAME (UNCHANGED STYLE) ================= */
function addGame(id,a,b){
  const w=prompt(`Who won?\n1: ${a}\n2: ${b}`);
  if(w!=="1"&&w!=="2") return;
  gameData.games.push({
    winner:w==="1"?a:b,
    loser:w==="1"?b:a,
    seriesId:id,
    time:new Date().toISOString()
  });
  saveLocal(); renderHomeActiveList();
}

/* ================= MODAL HELPERS (ORIGINAL STYLE) ================= */
function showModal(html){
  const d=document.createElement("div");
  d.id="modal";
  d.style.position="fixed";d.style.inset=0;d.style.background="rgba(0,0,0,.6)";
  d.innerHTML=`<div class="card" style="max-width:360px;margin:10% auto">${html}</div>`;
  document.body.appendChild(d);
}
function closeModal(){
  const m=document.getElementById("modal");
  if(m)m.remove();
}
  <!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bluff Masters</title>
<link rel="icon" href="blufffavicon.png" />
<style>
  :root{
    --bg1:#061226;
    --bg2:#081b31;
    --card:#0e2336;
    --muted:#9fb7bf;
    --accent:#2ecc71;
    --gold:#ffd36d;
    --danger:#ff6b6b;
  }
  html,body{height:100%;margin:0;font-family:Inter,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(circle at 10% 10%,var(--bg1),var(--bg2) 60%);color:#e6eef3;-webkit-font-smoothing:antialiased;}
  .wrap{max-width:1100px;margin:22px auto;padding:20px;}
  header{display:flex;align-items:center;gap:18px;margin-bottom:18px}
  .logo{width:62px;height:62px;border-radius:12px;background:linear-gradient(135deg,#ff6b6b,#ffd36d);display:flex;align-items:center;justify-content:center;font-weight:800;color:#07111a;box-shadow:0 8px 28px rgba(0,0,0,0.6)}
  h1{margin:0;font-size:28px}
  .subtitle{color:var(--muted);font-size:13px;margin-top:6px}

  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)); border-radius:14px;padding:16px;box-shadow: 8px 8px 32px rgba(2,6,12,0.6), -6px -6px 18px rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.03);}

  .section-title{font-size:28px;margin:6px 0 12px}
  .small-muted{font-size:0.9rem;color:var(--muted)}

  .active-wrap{margin-top:12px}
  #activeList{display:flex;flex-direction:column;gap:12px}
  .series-card{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.02)}
  .series-card .left{flex:1}
  .series-card .title{font-weight:700;font-size:1.05rem}
  .series-card .sub{color:var(--muted);font-size:0.9rem;margin-top:6px}
  .right-controls{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;background:linear-gradient(90deg, rgba(255,208,96,0.02), rgba(255,208,96,0.005));border:1px solid rgba(255,208,96,0.04)}
  .score{font-weight:800;font-size:1.05rem;margin-right:6px;color:#e9f7f1}
  .neu-btn{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));border-radius:10px;border:1px solid rgba(255,255,255,0.04);padding:10px 14px;color:#e6eef3;font-weight:700;cursor:pointer;transition:transform .12s ease,box-shadow .12s ease}
  .neu-btn.secondary{background:linear-gradient(180deg, rgba(0,0,0,0.06), rgba(255,255,255,0.01));color:#cfe3e3}
  .neu-btn:hover{transform:translateY(-3px);box-shadow:0 12px 30px rgba(0,0,0,0.5)}
  .trash{background:transparent;border:none;padding:8px;border-radius:8px;cursor:pointer;color:rgba(255,255,255,0.9)}
</style>
</head>

<body>
<div class="wrap">
<header>
  <div class="logo">28</div>
  <div>
    <h1>Bluff Masters</h1>
    <div class="subtitle">Track multiple active series, shared stats & celebrations</div>
  </div>
  <div style="flex:1"></div>
  <button class="neu-btn" onclick="goHome()">üè† Home</button>
</header>

<section id="homeSection">
  <div class="card hero">
    <img src="bluffmasters.png" style="width:100%;border-radius:10px;margin-bottom:14px">
    <div class="active-wrap card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div class="section-title">Active Series</div>
          <div class="small-muted" id="noActive">No Active Series ‚Äî start a new one.</div>
          <div id="seriesCount" style="margin-top:6px"></div>
        </div>
        <div style="display:flex;gap:12px">
          <button class="neu-btn" onclick="startNewSeries()">‚ûï New Series</button>
          <button class="neu-btn secondary" onclick="showStats()">üìä View Statistics</button>
        </div>
      </div>
      <div id="activeList" style="margin-top:14px"></div>
    </div>
  </div>
</section>

<section id="statsSection" class="card" style="display:none;margin-top:18px"></section>
</div>

<script type="module">
/* ================= ORIGINAL APP LOGIC START ================= */

/* (Firebase config, stats, celebrations, WhatsApp, etc. remain unchanged) */
/* ---------- ONLY SMALL INSERTIONS ARE DONE LATER ---------- */

const SECRET_KEY = "zachariahrenji";
const STORAGE_KEY = "bluff_tracker_v1";
const TEAM_LIST = ["Bibin & Zach","Bimal & Annu","Bibin & Annu","Zach & Daddy","Bibin & Bimal","Zach & Rikku","Bibin & Daddy"];

let gameData = { games: [] };
try{
  const raw = localStorage.getItem(STORAGE_KEY);
  if(raw) gameData = JSON.parse(raw);
}catch(e){}

function saveLocal(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(gameData)); }
function uid(p="s"){ return p+"_"+Date.now()+"_"+Math.floor(Math.random()*9000+1000); }
function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

/* ================= NEW SAFE HELPERS ================= */
function splitMembers(team){
  return team.split("&").map(x=>x.trim().toLowerCase());
}
function filterTeams(base, selected){
  if(!selected || selected==="__new__") return base;
  const blocked = splitMembers(selected);
  return base.filter(t=>{
    const m = splitMembers(t);
    return !m.some(x=>blocked.includes(x));
  });
}

/* ================= CORE AGGREGATION (UNCHANGED) ================= */
function computeAggregates(){
  const seriesMap = {};
  (gameData.games||[]).forEach(g=>{
    if(!seriesMap[g.seriesId]){
      seriesMap[g.seriesId]={games:[],wins:{},target:g.seriesTarget||5,ended:false};
    }
    const s=seriesMap[g.seriesId];
    s.games.push(g);
    s.wins[g.winner]=(s.wins[g.winner]||0)+1;
    if(g.seriesEndedManually) s.ended=true;
  });
  return {seriesMap};
}

/* ================= RENDER HOME (MINIMAL ADD) ================= */
function renderHomeActiveList(){
  const {seriesMap}=computeAggregates();
  const box=document.getElementById("activeList");
  box.innerHTML="";
  const active=Object.entries(seriesMap).filter(([_,s])=>!s.ended);
  document.getElementById("noActive").style.display=active.length?"none":"block";
  document.getElementById("seriesCount").textContent="Series Active: "+active.length;

  active.forEach(([id,s])=>{
    const teams=[...new Set(s.games.flatMap(g=>[g.winner,g.loser]))];
    const a=teams[0], b=teams[1];
    const card=document.createElement("div");
    card.className="series-card";

    const left=document.createElement("div");
    left.className="left";
    left.innerHTML=`<div class="title">${escapeHtml(a)} <span style="opacity:.6">vs</span> ${escapeHtml(b)}</div>`;

    const right=document.createElement("div");
    right.className="right-controls";

    const score=document.createElement("div");
    score.className="score";
    score.textContent=`${s.wins[a]||0} ‚Äî ${s.wins[b]||0}`;

    const add=document.createElement("button");
    add.className="neu-btn";
    add.textContent="‚ûï Add";
    add.onclick=()=>addGame(id,a,b);

    const end=document.createElement("button");
    end.className="neu-btn secondary";
    end.textContent="üõë End Series";
    end.onclick=()=>endSeries(id);

    right.append(score,add,end);
    card.append(left,right);
    box.appendChild(card);
  });
}

/* ================= START NEW SERIES (LOGIC UPDATED ONLY) ================= */
window.startNewSeries=function(){
  const baseOpts=TEAM_LIST.map(t=>`<option value="${t}">${t}</option>`).join("");
  const html=`
    <label>Target</label>
    <select id="tgt"><option value="5">5</option><option value="10">10</option></select>
    <label>Team A</label>
    <select id="ta">${baseOpts}<option value="__new__">‚ûï New Team</option></select>
    <input id="na" style="display:none;width:100%;margin-top:6px" placeholder="Enter team name">
    <label>Team B</label>
    <select id="tb">${baseOpts}<option value="__new__">‚ûï New Team</option></select>
    <input id="nb" style="display:none;width:100%;margin-top:6px" placeholder="Enter team name">
    <br><br>
    <button class="neu-btn" onclick="__createSeries()">Start</button>
  `;
  showModal(html);

  ta.onchange=()=>{
    na.style.display=ta.value==="__new__"?"block":"none";
    tb.innerHTML=
      filterTeams(TEAM_LIST,ta.value)
      .map(t=>`<option value="${t}">${t}</option>`).join("")+
      `<option value="__new__">‚ûï New Team</option>`;
  };
  tb.onchange=()=>nb.style.display=tb.value==="__new__"?"block":"none";

  window.__createSeries=function(){
    let A=ta.value==="__new__"?na.value.trim():ta.value;
    let B=tb.value==="__new__"?nb.value.trim():tb.value;
    if(!A||!B||A===B) return alert("Invalid teams");
    gameData.games.push({
      winner:A,loser:B,
      seriesId:uid("series"),
      seriesTarget:+tgt.value,
      time:new Date().toISOString()
    });
    saveLocal(); closeModal(); renderHomeActiveList();
  };
}

/* ================= END SERIES (NEW, SAFE) ================= */
function endSeries(id){
  const pw=prompt("Enter password to end series:");
  if(pw!==SECRET_KEY) return alert("Incorrect password");
  gameData.games.forEach(g=>{
    if(g.seriesId===id) g.seriesEndedManually=true;
  });
  saveLocal(); renderHomeActiveList();
}

/* ================= ADD GAME (UNCHANGED STYLE) ================= */
function addGame(id,a,b){
  const w=prompt(`Who won?\n1: ${a}\n2: ${b}`);
  if(w!=="1"&&w!=="2") return;
  gameData.games.push({
    winner:w==="1"?a:b,
    loser:w==="1"?b:a,
    seriesId:id,
    time:new Date().toISOString()
  });
  saveLocal(); renderHomeActiveList();
}

/* ================= MODAL HELPERS (ORIGINAL STYLE) ================= */
function showModal(html){
  const d=document.createElement("div");
  d.id="modal";
  d.style.position="fixed";d.style.inset=0;d.style.background="rgba(0,0,0,.6)";
  d.innerHTML=`<div class="card" style="max-width:360px;margin:10% auto">${html}</div>`;
  document.body.appendChild(d);
}
function closeModal(){
  const m=document.getElementById("modal");
  if(m)m.remove();
}
  </script>
</body>
</html>
