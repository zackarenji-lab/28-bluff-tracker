<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>28 | Bluff Masters</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
:root{
  --bg1:#071426;
  --bg2:#0f2b44;
  --card:#0f2230;
  --muted:#9fb7bf;
  --accent:#2ecc71;
  --glass: rgba(255,255,255,0.025);
  --soft-shadow: 15px 15px 30px rgba(0,0,0,0.6);
  --soft-highlight: -8px -8px 18px rgba(255,255,255,0.02);
}
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap');
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;color:#e8f7f6;background:linear-gradient(180deg,var(--bg1),var(--bg2));-webkit-font-smoothing:antialiased}
.container{max-width:1180px;margin:0 auto;padding:28px}
.header{
  position:sticky;top:12px;z-index:40;
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  padding:12px 18px;border-radius:14px;backdrop-filter: blur(6px);
  display:flex;align-items:center;justify-content:space-between;box-shadow:var(--soft-shadow), var(--soft-highlight);
}
.brand{display:flex;align-items:center;gap:14px}
.logo{
  width:56px;height:56px;border-radius:10px;background:linear-gradient(180deg,#ff5a5f,#ff9f43);
  display:flex;align-items:center;justify-content:center;font-weight:800;color:white;font-size:18px;box-shadow:0 6px 18px rgba(0,0,0,0.5)
}
.title{line-height:1}
.title h1{margin:0;font-size:1.3rem;color:#ff4e4e}
.title p{margin:0;color:var(--muted);font-size:0.86rem}
.home-btn{
  width:56px;height:56px;border-radius:50%;background:linear-gradient(180deg,#ffffff11,#00000011);
  display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,0.06);box-shadow: 6px 6px 18px rgba(0,0,0,0.5), -6px -6px 18px rgba(255,255,255,0.02)
}

/* hero */
.hero{
  margin-top:20px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:14px;padding:22px;box-shadow:var(--soft-shadow),var(--soft-highlight);
}
.hero-img{
  width:100%;border-radius:8px;display:block;margin:0 auto;max-height:360px;object-fit:contain;box-shadow: 0 8px 28px rgba(2,8,20,0.6);
  background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
}

/* Active series card (neumorphic) */
.active-card{
  margin-top:18px;padding:18px;border-radius:12px;background:linear-gradient(180deg,#0b2a3f,#071726);
  box-shadow: 10px 10px 24px rgba(0,0,0,0.6), -8px -8px 18px rgba(255,255,255,0.02);
  display:flex;flex-direction:column;
}
.controls{display:flex;justify-content:flex-end;gap:10px}
.neu-btn{
  padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer;background:linear-gradient(180deg,#0fffff0,#0e3); /* fallback */
  color:#052018;box-shadow: 6px 6px 14px rgba(0,0,0,0.5), -6px -6px 14px rgba(255,255,255,0.02);
}
.neu-btn.secondary{background:linear-gradient(180deg,#22343f,#12202a);color:#dff6f2;box-shadow: 6px 6px 14px rgba(0,0,0,0.6), -6px -6px 14px rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02)}
.active-list{margin-top:12px}
.series-card{background:var(--card);padding:12px;border-radius:10px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-between;align-items:center}
.series-card.lead{box-shadow: 0 6px 24px rgba(255,200,80,0.07), inset 0 0 18px rgba(255,200,80,0.02);border:1px solid rgba(255,200,80,0.06)}

/* champion banner */
.champion{
  margin-top:28px;padding:12px;border-radius:12px;background:linear-gradient(180deg,#071826,#0a2b3e);display:flex;align-items:center;gap:12px;box-shadow: var(--soft-shadow), var(--soft-highlight)
}
.champion .icon{width:64px;height:64px;border-radius:50%;background:linear-gradient(180deg,#ffd36d,#ffb347);display:flex;align-items:center;justify-content:center;font-weight:800;color:#3b2b00}
.champion .text{font-weight:700;color:#ffd;}

/* stats card (where stats and share live) */
.stats-card{margin-top:18px;padding:16px;border-radius:12px;background:linear-gradient(180deg,#081827,#071425);box-shadow:var(--soft-shadow),var(--soft-highlight)}
.stat-row{display:flex;gap:12px;flex-wrap:wrap}
.stat-box{flex:1;min-width:180px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);text-align:center}
.stat-box h3{margin:0;font-size:1.05rem}
.stat-box p{margin:6px 0 0 0;color:var(--muted)}

/* small helpers */
.note{color:var(--muted);font-size:0.95rem;margin-top:10px}
.linklike{cursor:pointer;color:#dff6f2;text-decoration:underline}
.screen{display:block}

/* responsive */
@media (max-width:820px){
  .header{flex-direction:column;gap:12px}
  .stat-row{flex-direction:column}
}
</style>
</head>
<body>
<div class="container">
  <div class="header" role="banner">
    <div class="brand">
      <div class="logo">28</div>
      <div class="title">
        <h1>Bluff Masters</h1>
        <p>Track multiple active series, shared stats & celebrations</p>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:12px">
      <div class="note" style="margin-right:20px">Welcome, Zach</div>
      <div class="home-btn" title="Home" onclick="goHome()" aria-hidden="false">üè†</div>
    </div>
  </div>

  <!-- HERO: image restored -->
  <div class="hero">
    <img src="bluffmasters.png" alt="Bluff Masters" class="hero-img" onerror="console.warn('Hero image not found: bluffmasters.png')" />
    <div class="active-card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700;font-size:1.05rem">Active Series</div>
        <div class="controls">
          <button class="neu-btn" onclick="startNewSeries()">‚ûï New Series</button>
          <button class="neu-btn secondary" onclick="showStats()">üìä View Statistics</button>
        </div>
      </div>

      <div id="activeList" class="active-list" style="margin-top:12px">
        <!-- filled dynamically -->
      </div>
      <div id="noActive" class="note">No Active Series ‚Äî start a new one.</div>
    </div>

    <div class="champion" id="championBanner">
      <div class="icon">1</div>
      <div class="text">Current Champions : <span id="championText"> ‚Äî </span></div>
    </div>
  </div>

  <!-- Stats (collapsed initially) -->
  <div id="statsSection" class="stats-card" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700">Overall Statistics</div>
      <div>
        <button class="neu-btn" onclick="shareToWhatsApp()">üì§ Share to WhatsApp</button>
        <button class="neu-btn secondary" onclick="goHome()">‚Üê Back</button>
      </div>
    </div>

    <div class="stat-row" style="margin-top:12px">
      <div class="stat-box">
        <h3 id="totalGames">0</h3><p>Total Games</p>
      </div>
      <div class="stat-box">
        <h3 id="totalSeries">0</h3><p>Total Series (completed)</p>
      </div>
    </div>

    <div id="summaryBreakdown" style="margin-top:12px"></div>

    <div id="teamStats" style="margin-top:12px"></div>

    <h3 style="margin-top:14px">Game History</h3>
    <div id="gameHistory"></div>

    <div style="margin-top:10px;font-size:0.95rem">
      <span class="linklike" onclick="deleteLastGame()">Delete last game</span> &nbsp;‚Ä¢&nbsp;
      <span class="linklike" onclick="resetStats()">Reset all statistics</span>
    </div>
  </div>

</div>

<!-- modal container and fireworks canvas -->
<div id="modalContainer"></div>
<canvas id="fireworks" class="fireworks-canvas"></canvas>

<script type="module">
/* Firebase (best-effort) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBdAIdEDwfoalevfadgixPTLIoLoEqi8kc",
  authDomain: "bluff-tracker-7542e.firebaseapp.com",
  projectId: "bluff-tracker-7542e",
  storageBucket: "bluff-tracker-7542e.firebasestorage.app",
  messagingSenderId: "280965687037",
  appId: "1:280965687037:web:be0b05da36ef653ab68094"
};

let db=null,gamesRef=null;
try{
  const app = initializeApp(firebaseConfig);
  db = getFirestore(app);
  gamesRef = collection(db,'games');
  console.log('Firebase inited');
}catch(e){ console.warn('Firebase init failed', e); }

/* ------------------------
   Core model and storage
   ------------------------ */
let gameData = { games: [] };
const STORAGE_KEY = 'bluff_tracker_v1';
const TEAM_LIST = [
  "Bibin & Zach",
  "Bimal & Annu",
  "Bibin & Annu",
  "Zach & Daddy",
  "Bibin & Bimal",
  "Zach & Rikku",
  "Bibin & Daddy"
];

(function loadLocal(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw) gameData = JSON.parse(raw);
  }catch(e){ console.warn('local load failed', e); }
})();

/* Aggregation helper */
function computeAggregates(){
  const seriesMap = {}; // id -> {id,target,games,wins,finished,winner,startedAt}
  const teamStats = {}; // team -> {wins,losses,seriesWon,consecutiveSeries}
  (gameData.games || []).forEach(g=>{
    const sid = g.seriesId || ("series_"+(g.seriesStartedAt||g.time||Date.now()));
    if(!seriesMap[sid]) seriesMap[sid] = { id: sid, target: g.seriesTarget || 5, games: [], wins: {}, finished:false, winner:null, startedAt: g.seriesStartedAt || g.time || new Date().toISOString() };
    const s = seriesMap[sid];
    s.games.push(g);
    s.wins[g.winner] = (s.wins[g.winner]||0) + 1;
    if(s.wins[g.winner] >= s.target && !s.finished){ s.finished = true; s.winner = g.winner; }
    if(!teamStats[g.winner]) teamStats[g.winner] = { wins:0, losses:0, seriesWon:0, consecutiveSeries:0 };
    if(!teamStats[g.loser]) teamStats[g.loser] = { wins:0, losses:0, seriesWon:0, consecutiveSeries:0 };
    teamStats[g.winner].wins++;
    teamStats[g.loser].losses++;
  });

  const finishedSeries = Object.values(seriesMap).filter(s=>s.finished).sort((a,b)=>new Date(a.startedAt)-new Date(b.startedAt));
  const streaks = {};
  finishedSeries.forEach(s=>{
    const w = s.winner;
    if(!teamStats[w]) teamStats[w] = { wins:0, losses:0, seriesWon:0, consecutiveSeries:0 };
    teamStats[w].seriesWon = (teamStats[w].seriesWon||0) + 1;
    streaks[w] = (streaks[w]||0) + 1;
    Object.keys(streaks).forEach(t=>{ if(t!==w) streaks[t] = 0; });
    teamStats[w].consecutiveSeries = streaks[w];
  });

  const activeSeries = Object.values(seriesMap).filter(s=>!s.finished).sort((a,b)=>new Date(b.startedAt)-new Date(a.startedAt));

  const completedByTarget = {5:0,10:0};
  finishedSeries.forEach(s=>{
    if(s.target === 5) completedByTarget[5] = (completedByTarget[5] || 0) + 1;
    if(s.target === 10) completedByTarget[10] = (completedByTarget[10] || 0) + 1;
  });

  return { seriesMap, teamStats, activeSeries, completedSeriesCount: finishedSeries.length, completedByTarget };
}

/* Save local helper */
function saveLocal(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(gameData)); }catch(e){ console.warn('saveLocal failed', e);} }

/* ------------------------
   UI rendering functions
   ------------------------ */
function renderHomeActiveList(){
  const { activeSeries } = computeAggregates();
  const container = document.getElementById('activeList');
  container.innerHTML = '';
  if(!activeSeries || activeSeries.length === 0){
    document.getElementById('noActive').style.display = 'block';
    return;
  }
  document.getElementById('noActive').style.display = 'none';
  activeSeries.forEach(s=>{
    const wins = s.wins || {};
    const pair = Array.from(new Set(s.games.flatMap(g=>[g.winner,g.loser]))).slice(0,2);
    const t1 = pair[0] || TEAM_LIST[0];
    const t2 = pair[1] || TEAM_LIST[1];
    const s1 = wins[t1] || 0;
    const s2 = wins[t2] || 0;
    const el = document.createElement('div');
    el.className = 'series-card' + ((s1!==s2)?' lead':'');
    el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-weight:700">${escapeHtml(t1)} <span style="opacity:0.7">vs</span> ${escapeHtml(t2)}</div>
        <div style="font-size:0.9rem;color:var(--muted)">First to ${s.target} wins ‚Ä¢ started ${new Date(s.startedAt).toLocaleString()}</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:1.1rem;font-weight:800">${s1} ‚Äî ${s2}</div>
        <div style="margin-top:8px">
          <button class="neu-btn" onclick="resumeSeries('${s.id}')">‚ûï Add</button>
          <button class="neu-btn secondary" onclick="viewSeriesDetails('${s.id}')">Details</button>
        </div>
      </div>
    </div>`;
    container.appendChild(el);
  });
}

/* render champion banner and stats summary card */
function updateStatsUI(){
  const { seriesMap, teamStats, activeSeries, completedByTarget, completedSeriesCount } = computeAggregates();
  document.getElementById('totalGames').textContent = (gameData.games||[]).length;
  document.getElementById('totalSeries').textContent = completedSeriesCount;

  // champion (highest wins)
  const teams = Object.keys(teamStats || {}).sort((a,b)=> (teamStats[b].wins||0) - (teamStats[a].wins||0));
  const champion = teams.length ? teams[0] : "‚Äî";
  document.getElementById('championText').textContent = champion;

  // breakdown
  const breakdown = document.getElementById('summaryBreakdown');
  breakdown.innerHTML = `<div style="margin-top:8px">
    <div style="font-weight:700">Completed Series Breakdown</div>
    <div style="margin-left:8px;color:var(--muted)">5 Series ‚Üí ${completedByTarget[5] || 0} completed</div>
    <div style="margin-left:8px;color:var(--muted)">10 Series ‚Üí ${completedByTarget[10] || 0} completed</div>
  </div>`;

  // team cards sorted by wins
  const tContainer = document.getElementById('teamStats');
  tContainer.innerHTML = '';
  Object.keys(teamStats || {}).sort((a,b)=> (teamStats[b].wins||0) - (teamStats[a].wins||0)).forEach((team, idx)=>{
    const s = teamStats[team];
    const w = s.wins||0, l = s.losses||0, sw = s.seriesWon||0, cs = s.consecutiveSeries||0;
    const total = w + l; const wp = total ? Math.round((w/total)*100) : 0;
    const div = document.createElement('div');
    div.className = 'team-item';
    div.innerHTML = `<div style="font-weight:700">${escapeHtml(team)} ${idx===0?'<span style="color:#ffd36d">üëë</span>':''}</div>
      <div class="metric-row" style="margin-top:8px">
        <div class="metric-box"><div style="opacity:0.7">Wins</div><div style="font-size:1.1rem">${w}</div></div>
        <div class="metric-box"><div style="opacity:0.7">Losses</div><div style="font-size:1.1rem">${l}</div></div>
        <div class="metric-box"><div style="opacity:0.7">Series</div><div style="font-size:1.1rem">${sw}${cs>0?` <small>(${cs} streak)</small>`:''}</div></div>
        <div class="metric-box"><div style="opacity:0.7">Win %</div><div style="font-size:1.1rem">${wp}%</div></div>
      </div>`;
    tContainer.appendChild(div);
  });

  // history list
  const hist = (gameData.games || []).slice().reverse().map(g=>{
    return `<div style="background:rgba(255,255,255,0.02);padding:10px;margin:8px 0;border-radius:8px">
      <small style="opacity:0.7">${new Date(g.time).toLocaleString()}</small><br><b>${escapeHtml(g.winner)}</b> beat <b>${escapeHtml(g.loser)}</b> <small style="opacity:0.7">[Series:${g.seriesId}, target:${g.seriesTarget||5}]</small>
    </div>`;
  }).join('');
  document.getElementById('gameHistory').innerHTML = hist || '<div style="opacity:0.75">No games yet</div>';
}

/* ------------------------
   Start New Series (modal with dropdowns)
   ------------------------ */
window.startNewSeries = () => {
  const teamOptions = TEAM_LIST.map(t => `<option>${escapeHtml(t)}</option>`).join('');
  const html = `
    <div style="text-align:left">
      <label>Series target (first to N wins):</label>
      <select id="modalSeriesTarget" style="width:100%;padding:8px;margin-top:6px">
        <option value="5">First to 5</option>
        <option value="10">First to 10</option>
      </select>
      <label style="margin-top:10px;display:block">Winner team (first match):</label>
      <select id="modalWinner" style="width:100%;padding:8px;margin-top:6px">${teamOptions}</select>
      <label style="margin-top:10px;display:block">Loser team (first match):</label>
      <select id="modalLoser" style="width:100%;padding:8px;margin-top:6px">${teamOptions}</select>
    </div>
  `;
  showModal('Start New Series', html, () => {
    const target = parseInt(document.getElementById('modalSeriesTarget').value,10) || 5;
    const winner = document.getElementById('modalWinner').value.trim();
    const loser  = document.getElementById('modalLoser').value.trim();
    if(!winner || !loser) { alert('Please pick both teams'); return; }
    if(winner === loser) { alert('Winner and loser cannot be same'); return; }
    const sid = 'series_' + Date.now() + '_' + Math.floor(Math.random()*9999);
    const rec = { winner, loser, seriesId: sid, seriesTarget: target, seriesStartedAt: new Date().toISOString(), time: new Date().toISOString() };
    gameData.games.push(rec);
    saveLocal();
    cloudSaveGame(rec);
    afterLocalSave(rec);
  }, 'Start Series');
};

/* ------------------------
   Resume series: choose winner/loser from teams present (or from team list fallback)
   ------------------------ */
window.resumeSeries = (seriesId) => {
  const { seriesMap } = computeAggregates();
  const s = seriesMap[seriesId];
  if(!s) return alert('Series not found');
  const teams = Array.from(new Set(s.games.flatMap(g=>[g.winner,g.loser])));
  // if not enough teams, fallback to TEAM_LIST
  const opts = (teams.length ? teams : TEAM_LIST).map(t => `<option>${escapeHtml(t)}</option>`).join('');
  const html = `<div>
    <div style="margin-top:6px">Winner:</div><select id="modalWinnerSelect" style="width:100%;padding:8px;margin-top:6px">${opts}</select>
    <div style="margin-top:10px">Loser:</div><select id="modalLoserSelect" style="width:100%;padding:8px;margin-top:6px">${opts}</select>
  </div>`;
  showModal('Add Match', html, () => {
    const winner = document.getElementById('modalWinnerSelect').value;
    const loser = document.getElementById('modalLoserSelect').value;
    if(!winner || !loser){ alert('Choose teams'); return; }
    if(winner === loser){ alert('Winner and loser cannot be same'); return; }
    const rec = { winner, loser, seriesId: s.id, seriesTarget: s.target, seriesStartedAt: s.startedAt, time: new Date().toISOString() };
    gameData.games.push(rec);
    saveLocal(); cloudSaveGame(rec); afterLocalSave(rec);
  }, 'Save');
};

/* view series history */
window.viewSeriesDetails = (seriesId) => {
  const games = (gameData.games || []).filter(g=>g.seriesId === seriesId).sort((a,b)=> new Date(a.time) - new Date(b.time));
  const rows = games.map((g,i)=>`<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)">${i+1}. ${new Date(g.time).toLocaleString()} ‚Äî <b>${escapeHtml(g.winner)}</b> beat <b>${escapeHtml(g.loser)}</b></div>`).join('');
  showModal('Series Details', `<div style="max-height:320px;overflow:auto">${rows || '<i>No games yet</i>'}</div>`, ()=>{}, 'Close');
};

/* ------------------------
   After local save: UI updates, message & graphics
   ------------------------ */
function afterLocalSave(rec){
  renderHomeActiveList();
  updateStatsUI();
  const msg = buildSeriesProgressMessage(rec);
  showLargeConfirm('‚úÖ Game Saved', msg, () => { showStats(); });
  maybeShowGraphics(rec);
}

/* Build series progress message */
function buildSeriesProgressMessage(rec){
  const { seriesMap, teamStats } = computeAggregates();
  const s = seriesMap[rec.seriesId];
  const winner = rec.winner, loser = rec.loser;
  const winnerWins = s.wins[winner] || 0;
  const loserWins = s.wins[loser] || 0;
  const remaining = Math.max(0, s.target - winnerWins);

  if(winnerWins >= s.target){
    const scoreLine = `${winnerWins}-${loserWins}`;
    if(loserWins === 0){
      return `<div class="confirm-message"><b>FLAWLESS VICTORY! ${scoreLine}!</b><br>${escapeHtml(winner)} sweeps the series!</div><div class="small-muted">Saved locally and syncing to cloud.</div>`;
    }
    const streak = (teamStats[winner] && teamStats[winner].consecutiveSeries) || 1;
    if(streak >= 3) return `<div class="confirm-message"><b>üî• HAT-TRICK! ${escapeHtml(winner)} wins again ‚Äî ${scoreLine}!</b><br>Incredible streak: ${streak} consecutive series!</div>`;
    if(streak === 2) return `<div class="confirm-message"><b>üèÜ Series Won ‚Äî ${scoreLine}</b><br>Yaay.. Another fabulous series. ${escapeHtml(winner)} won ${streak} series in a row! All the best for a Hat-Trick!</div>`;
    return `<div class="confirm-message"><b>üèÜ Series Won ‚Äî ${scoreLine}</b><br>${escapeHtml(winner)} wins this series!</div>`;
  } else {
    return `<div class="confirm-message"><b>${escapeHtml(winner)} beat ${escapeHtml(loser)}</b><br>${escapeHtml(winner)} needs <b>${remaining}</b> more win${remaining===1?'':'s'} to reach ${s.target} wins in this series.</div><div class="small-muted">Saved locally and syncing to cloud.</div>`;
  }
}

/* ------------------------
   Confetti & Fireworks
   ------------------------ */
function simpleConfetti(){
  const canvas = document.createElement('canvas');
  canvas.style.position='fixed'; canvas.style.left=0; canvas.style.top=0; canvas.style.width='100%'; canvas.style.height='100%'; canvas.style.zIndex=99998; canvas.style.pointerEvents='none';
  document.body.appendChild(canvas);
  const ctx = canvas.getContext('2d');
  function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
  resize(); window.addEventListener('resize', resize);
  const colors=['#ffdd57','#ff6b6b','#44ff8a','#6ec0ff','#ff9ce3'];
  const p=[];
  for(let i=0;i<80;i++){
    p.push({ x:Math.random()*canvas.width, y:-Math.random()*canvas.height, w:6+Math.random()*10, h:6+Math.random()*10, vx:-2+Math.random()*4, vy:2+Math.random()*4, color:colors[Math.floor(Math.random()*colors.length)], rot:Math.random()*360, vr:-5+Math.random()*10 });
  }
  let last = performance.now();
  function frame(t){
    const dt=(t-last)/16.67; last=t; ctx.clearRect(0,0,canvas.width,canvas.height);
    p.forEach(a=>{ a.x+=a.vx*dt; a.y+=a.vy*dt; a.vy+=0.05*dt; a.rot+=a.vr*dt; ctx.save(); ctx.translate(a.x,a.y); ctx.rotate(a.rot*Math.PI/180); ctx.fillStyle=a.color; ctx.fillRect(-a.w/2,-a.h/2,a.w,a.h); ctx.restore(); });
    if(p.every(a=>a.y>canvas.height+50)){ canvas.remove(); return; }
    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
}

function startFireworks(duration=2800){
  const canvas = document.getElementById('fireworks');
  if(!canvas) return;
  canvas.style.display = 'block';
  const ctx = canvas.getContext('2d');
  function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
  resize(); window.addEventListener('resize', resize);
  const fireworks = [];
  function spawn(){ const x = Math.random()*canvas.width; const y = Math.random()*canvas.height*0.6; const count = 30 + Math.round(Math.random()*40); const hue = Math.round(Math.random()*360); for(let i=0;i<count;i++){ const speed = Math.random()*4 + 1; const angle = Math.random()*Math.PI*2; fireworks.push({ x,y,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed,life:60+Math.round(Math.random()*40),color:`hsl(${hue} ${60+Math.round(Math.random()*40)}% ${40+Math.round(Math.random()*40)}%)` }); } }
  let last = performance.now();
  function frame(t){ const dt=(t-last)/16.67; last=t; ctx.fillStyle='rgba(0,0,0,0.18)'; ctx.fillRect(0,0,canvas.width,canvas.height); for(let i=fireworks.length-1;i>=0;i--){ const p=fireworks[i]; p.x+=p.vx*dt; p.y+=p.vy*dt; p.vy+=0.06*dt; p.life--; ctx.beginPath(); ctx.fillStyle=p.color; ctx.arc(p.x,p.y, Math.max(0,Math.min(3,p.life/10)), 0, Math.PI*2); ctx.fill(); if(p.life<=0) fireworks.splice(i,1); } requestAnimationFrame(frame); }
  const sp = setInterval(spawn,250);
  requestAnimationFrame(frame);
  setTimeout(()=>{ clearInterval(sp); setTimeout(()=>{ canvas.style.display='none'; },1200); }, duration);
}

function maybeShowGraphics(rec){
  const { seriesMap } = computeAggregates();
  const s = seriesMap[rec.seriesId];
  const ww = s.wins[rec.winner] || 0;
  const lw = s.wins[rec.loser] || 0;
  if(ww >= s.target && lw === 0) startFireworks(3200); else simpleConfetti();
}

/* ------------------------
   Cloud write (non-blocking)
   ------------------------ */
async function cloudSaveGame(rec){
  if(!gamesRef) return;
  try{
    await Promise.race([ addDoc(gamesRef, rec), new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),2000)) ]);
    console.log('Cloud write OK');
  }catch(e){ console.warn('Cloud save failed', e); }
}

/* ------------------------
   Delete last & Reset (exposed)
   ------------------------ */
function deleteLastGame(){
  if(!(gameData.games && gameData.games.length)) { alert('No games to delete.'); return; }
  const pw = prompt('Enter password to delete last game:');
  if(pw !== 'zachariahrenji'){ alert('‚ùå Incorrect password'); return; }
  if(!confirm('Delete the most recent game permanently?')) return;
  gameData.games.pop();
  saveLocal(); renderHomeActiveList(); updateStatsUI();
  showLargeConfirm('‚úÖ Last Game Deleted', `<div class="confirm-message">Last game removed from history.</div>`, ()=>{ showStats(); });
}

function resetStats(){
  const pw = prompt('Enter password to reset all data:');
  if(pw !== 'zachariahrenji'){ alert('‚ùå Incorrect password'); return; }
  if(!confirm('‚ö†Ô∏è This will permanently delete ALL local stats. Continue?')) return;
  gameData = { games: [] };
  saveLocal(); renderHomeActiveList(); updateStatsUI();
  showLargeConfirm('‚úÖ Reset Complete', `<div class="confirm-message">All statistics erased locally.</div>`, ()=>{ goHome(); });
}
window.deleteLastGame = deleteLastGame;
window.resetStats = resetStats;

/* ------------------------
   Modal helpers
   ------------------------ */
function showModal(title, html, onOk, okText='OK'){
  closeModal();
  const overlay = document.createElement('div'); overlay.className = 'overlay';
  const box = document.createElement('div'); box.className = 'confirm-box';
  box.innerHTML = `<div class="confirm-title">${title}</div><div style="text-align:left">${html}</div>`;
  const row = document.createElement('div'); row.style.marginTop='12px'; row.style.display='flex'; row.style.justifyContent='center'; row.style.gap='8px';
  const ok = document.createElement('button'); ok.className = 'neu-btn'; ok.innerText = okText; ok.onclick = ()=>{ onOk && onOk(); closeModal(); };
  const cancel = document.createElement('button'); cancel.className = 'neu-btn secondary'; cancel.innerText = 'Cancel'; cancel.onclick = closeModal;
  row.appendChild(ok); row.appendChild(cancel); box.appendChild(row); overlay.appendChild(box); document.getElementById('modalContainer').appendChild(overlay);
}
function showLargeConfirm(title, html, onOk){
  closeModal();
  const overlay = document.createElement('div'); overlay.className = 'overlay';
  const box = document.createElement('div'); box.className = 'confirm-box';
  box.innerHTML = `<div class="confirm-title">${title}</div><div class="confirm-message">${html}</div>`;
  const ok = document.createElement('button'); ok.className = 'neu-btn'; ok.innerText = 'OK'; ok.onclick = ()=>{ closeModal(); onOk && onOk(); };
  box.appendChild(ok); overlay.appendChild(box); document.getElementById('modalContainer').appendChild(overlay);
}
function closeModal(){ document.getElementById('modalContainer').innerHTML = ''; }

/* ------------------------
   Firestore snapshot: replace local with cloud canonical (best-effort)
   ------------------------ */
if(gamesRef){
  try{
    onSnapshot(gamesRef, snapshot => {
      const docs = snapshot.docs.map(d => d.data()).sort((a,b)=> new Date(a.time) - new Date(b.time));
      if(docs && docs.length > 0){
        gameData.games = docs;
        saveLocal();
        renderHomeActiveList(); updateStatsUI();
        console.log('Synced from cloud: ', docs.length);
      }
    }, err => { console.warn('onSnapshot error', err); });
  }catch(e){ console.warn('onSnapshot failed', e); }
}

/* ------------------------
   Stats share: WhatsApp (format per spec)
   ------------------------ */
function shareToWhatsApp(){
  const { seriesMap, teamStats } = computeAggregates();
  const totalGames = (gameData.games || []).length;
  const completed = Object.values(seriesMap).filter(s => s.finished);
  const completedByTarget = {5:0,10:0};
  completed.forEach(s=>{ if(s.target===5) completedByTarget[5]++; if(s.target===10) completedByTarget[10]++; });

  const teamsByWins = Object.keys(teamStats || {}).sort((a,b)=> (teamStats[b].wins||0) - (teamStats[a].wins||0));
  const topWins = teamsByWins.slice(0,2).map((t,i)=> `${i+1}Ô∏è‚É£ ${t} ‚Äî ${teamStats[t].wins || 0} Games | ${teamStats[t].seriesWon || 0} Series`);
  const teamsByLosses = Object.keys(teamStats || {}).sort((a,b)=> (teamStats[b].losses||0) - (teamStats[a].losses||0));
  const topLosses = teamsByLosses.slice(0,2).map((t,i)=> `${i+1}Ô∏è‚É£ ${t} ‚Äî ${teamStats[t].losses || 0} Games | ${teamStats[t].seriesWon || 0} Series`);
  const champion = teamsByWins.length ? teamsByWins[0] : "‚Äî";

  // Best games: include flawless (loser 0) as well as top margin series
  let bestMargin = -1;
  const completedDetails = completed.map(s=>{
    const tally = {};
    s.games.forEach(g => { tally[g.winner] = (tally[g.winner]||0) + 1; tally[g.loser] = tally[g.loser] || 0; });
    const winnerTeam = s.winner;
    const winnerWins = tally[winnerTeam] || 0;
    const opponents = Array.from(new Set(s.games.flatMap(g=>[g.winner,g.loser]))).filter(x=>x!==winnerTeam);
    const opponentMaxWins = opponents.length ? Math.max(...opponents.map(o => tally[o]||0)) : 0;
    const margin = winnerWins - opponentMaxWins;
    if(margin > bestMargin) bestMargin = margin;
    return { series: s, winner: winnerTeam, winnerWins, opponentMaxWins, opponents };
  });

  const flawless = completedDetails.filter(d => d.opponentMaxWins === 0).map(d => ({ winner:d.winner, score:`${d.winnerWins}-${d.opponentMaxWins}`, opponents: d.opponents }));
  const bestMarginList = completedDetails.filter(d => (d.winnerWins - d.opponentMaxWins) === bestMargin).map(d => ({ winner:d.winner, score:`${d.winnerWins}-${d.opponentMaxWins}`, opponents: d.opponents }));

  // combine unique entries: list all flawless entries first, then best margin (if not duplicate)
  const finalBest = [];
  const seen = new Set();
  flawless.forEach(it => { const key = `${it.winner}|${it.score}|${it.opponents.join(',')}`; if(!seen.has(key)){ finalBest.push(it); seen.add(key); }});
  bestMarginList.forEach(it => { const key = `${it.winner}|${it.score}|${it.opponents.join(',')}`; if(!seen.has(key)){ finalBest.push(it); seen.add(key); }});

  // Build message
  let msg = `üé¥ Bluff Masters ‚Äî Overall Stats\n\nTotal Games: ${totalGames}\nTotal Series:\n  5 Series ‚Üí ${completedByTarget[5]||0} completed\n  10 Series ‚Üí ${completedByTarget[10]||0} completed\n\nüèÜ Total Wins (Top 2):\n`;
  msg += (topWins.length ? topWins.join('\n') : 'None\n') + '\n\n';
  msg += 'üíî Total Losses (Top 2):\n' + (topLosses.length ? topLosses.join('\n') : 'None\n') + '\n\n';
  msg += `üëë Current Champions: ${champion}\n\n`;
  if(finalBest.length){
    msg += 'üî• Best Game(s):\n';
    finalBest.forEach(it => { msg += `${it.winner} ‚Äî ${it.score} vs ${it.opponents.join(', ')}\n`; });
  } else {
    msg += 'üî• Best Game(s): None\n';
  }

  const url = 'https://api.whatsapp.com/send?text=' + encodeURIComponent(msg);
  window.open(url, '_blank');
}
window.shareToWhatsApp = shareToWhatsApp;

/* ------------------------
   Helpers
   ------------------------ */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

/* ------------------------
   Navigation helpers
   ------------------------ */
window.goHome = () => { document.getElementById('statsSection').style.display = 'none'; document.querySelector('.hero').scrollIntoView({behavior:'smooth'}); renderHomeActiveList(); updateStatsUI(); };
window.showStats = () => { document.getElementById('statsSection').style.display = 'block'; renderHomeActiveList(); updateStatsUI(); document.getElementById('statsSection').scrollIntoView({behavior:'smooth'}); };

/* ------------------------
   initial render & Firestore snapshot hookup
   ------------------------ */
renderHomeActiveList(); updateStatsUI();

/* Firestore listener (already defined above in snippet earlier) - preserved earlier code */
console.log('Bluff Masters loaded. Local data ready. Firebase sync (if available) runs in background.');
</script>
</body>
</html>
