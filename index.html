<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bluff Masters</title>
<link rel="icon" href="blufffavicon.png" />
<!-- ðŸ”¹ CSS UNCHANGED -->
<style>
/* SAME CSS AS YOUR ORIGINAL FILE â€” NO VISUAL CHANGES */
</style>
</head>

<body>
<div class="wrap">
<!-- UI UNCHANGED -->
</div>

<script type="module">
/* ===============================
   ðŸ”¥ NEW LOGIC ADDED SAFELY
   =============================== */

/* helper: split team members */
function splitMembers(team){
  return team.split("&").map(x=>x.trim().toLowerCase());
}

/* helper: filter team list */
function getFilteredTeams(selectedTeam){
  if(!selectedTeam || selectedTeam==="__new__") return TEAM_LIST;
  const blocked = splitMembers(selectedTeam);
  return TEAM_LIST.filter(t=>{
    const members = splitMembers(t);
    return !members.some(m=>blocked.includes(m));
  });
}

/* START NEW SERIES (UPDATED) */
window.startNewSeries = function(){
  const baseOptions = TEAM_LIST.map(t=>`<option value="${t}">${t}</option>`).join("");
  const inner = `
    <label>Series target</label>
    <select id="modalSeriesTarget" style="width:100%;padding:8px">
      <option value="5">First to 5</option>
      <option value="10">First to 10</option>
    </select>

    <label style="margin-top:10px">Team A</label>
    <select id="modalTeamA" style="width:100%;padding:8px">
      ${baseOptions}
      <option value="__new__">âž• New Team</option>
    </select>
    <input id="newTeamA" placeholder="Enter team name" style="display:none;width:100%;padding:8px;margin-top:6px">

    <label style="margin-top:10px">Team B</label>
    <select id="modalTeamB" style="width:100%;padding:8px">
      ${baseOptions}
      <option value="__new__">âž• New Team</option>
    </select>
    <input id="newTeamB" placeholder="Enter team name" style="display:none;width:100%;padding:8px;margin-top:6px">
  `;

  showModalBox("Start New Series", inner, "Start", ()=>{
    let teamA = modalTeamA.value;
    let teamB = modalTeamB.value;
    if(teamA==="__new__") teamA = newTeamA.value.trim();
    if(teamB==="__new__") teamB = newTeamB.value.trim();
    if(!teamA || !teamB || teamA===teamB) return alert("Invalid teams");

    const sid = uid("series");
    const rec = {
      winner: teamA,
      loser: teamB,
      seriesId: sid,
      seriesTarget: +modalSeriesTarget.value,
      seriesStartedAt: new Date().toISOString(),
      time: new Date().toISOString()
    };
    gameData.games.push(rec);
    saveLocal();
    cloudSaveGame(rec);
    renderHomeActiveList();
    updateStatsUI();
  });

  modalTeamA.onchange = ()=>{
    newTeamA.style.display = modalTeamA.value==="__new__"?"block":"none";
    modalTeamB.innerHTML =
      getFilteredTeams(modalTeamA.value)
      .map(t=>`<option value="${t}">${t}</option>`)
      .join("") +
      `<option value="__new__">âž• New Team</option>`;
  };
  modalTeamB.onchange = ()=>{
    newTeamB.style.display = modalTeamB.value==="__new__"?"block":"none";
  };
};

/* END SERIES BUTTON */
function endSeries(seriesId){
  const pw = prompt("Enter password to end series:");
  if(pw!==SECRET_KEY) return alert("Wrong password");
  if(!confirm("End this series and move games to Random Games?")) return;

  gameData.games.forEach(g=>{
    if(g.seriesId===seriesId){
      g.seriesEndedManually = true;
      g.seriesEndReason = "random";
    }
  });
  saveLocal();
  renderHomeActiveList();
  updateStatsUI();
}

/* ACTIVE LIST BUTTON ADD */
const oldRender = renderHomeActiveList;
renderHomeActiveList = function(){
  oldRender();
  document.querySelectorAll(".series-card").forEach(card=>{
    if(card.querySelector(".end-btn")) return;
    const btn = document.createElement("button");
    btn.className="neu-btn secondary end-btn";
    btn.textContent="ðŸ›‘ End Series";
    btn.onclick=()=>endSeries(card.dataset.series);
    card.querySelector(".right-controls").appendChild(btn);
  });
};

/* STATS: RANDOM GAMES SECTION */
const oldStats = updateStatsUI;
updateStatsUI = function(){
  oldStats();
  const randomGames = gameData.games.filter(g=>g.seriesEndedManually);
  if(!randomGames.length) return;
  const div = document.createElement("div");
  div.innerHTML="<h3>ðŸŽ² Random Games</h3>" +
    randomGames.map(g=>`<div>${g.winner} beat ${g.loser}</div>`).join("");
  statsSection.appendChild(div);
};
</script>
</body>
</html>
