<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bluff Masters</title>

<style>
:root{
  --color-primary:#2ecc71;
  --color-dark:#ecf0f1;
}
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
  background:radial-gradient(circle at top,#1e335f,#000814 65%,#111 100%);
  color:var(--color-dark);
  padding:20px;min-height:100vh;
}
.container{max-width:900px;margin:auto}
.card{backdrop-filter:blur(10px);background:rgba(255,255,255,0.05);border-radius:14px;padding:20px;margin-bottom:16px;border:1px solid rgba(255,255,255,0.06)}
.top-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
.header h1{margin:0;font-size:1.6rem}
.btn{width:100%;padding:12px;border-radius:10px;border:none;font-weight:700;cursor:pointer;margin:8px 0}
.btn-primary{background:var(--color-primary);color:#051011}
.btn-primary:hover{box-shadow:0 0 12px rgba(46,204,113,0.9);transform:translateY(-2px)}
.btn-secondary{background:#444;color:white}
.home-image{width:100%;border-radius:12px;margin-bottom:14px;opacity:0;animation:fadeIn 1s forwards}
@keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
.team-item{background:rgba(0,0,0,0.45);padding:12px;border-radius:10px;margin:8px 0;border:1px solid rgba(255,255,255,0.06)}
.metric-row{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:6px}
.metric-box{background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;text-align:center;border:1px solid rgba(255,255,255,0.05)}
.bar-graph{height:8px;width:100%;background:#111;border-radius:6px;overflow:hidden;display:flex;margin-top:8px}
.bar-wins{background:#2ecc71;transition:width 1s ease}
.bar-losses{background:#e74c3c;transition:width 1s ease}
.champion-team{border:2px solid gold;animation:glow 2.2s infinite;position:relative}
.champion-team::before{content:"üëë";position:absolute;top:-10px;right:-10px;font-size:1.4rem}
@keyframes glow{0%{box-shadow:0 0 6px gold}50%{box-shadow:0 0 20px gold}100%{box-shadow:0 0 6px gold}}
</style>
</head>
<body>
<div class="container">
  <div class="top-row">
    <div class="header">
      <h1>Bluff Masters</h1>
      <div style="color:#cdd8e2;font-size:0.95rem">Track wins, series & shared stats</div>
    </div>
    <button id="homeBtn" class="btn btn-secondary" style="display:none" onclick="goHome()">üè† Home</button>
  </div>

  <!-- HOME -->
  <div id="homeScreen" class="screen active">
    <div class="card" style="text-align:center">
      <img src="bluffmasters.png" class="home-image" />
      <h2 style="margin:10px 0 12px 0">Welcome</h2>
      <button class="btn btn-primary" onclick="startNewGame()">‚ûï New Game</button>
      <button class="btn btn-secondary" onclick="showStats()">üìä View Statistics</button>
    </div>
  </div>

  <!-- GAME TYPE -->
  <div id="gameTypeScreen" class="screen" style="display:none">
    <div class="card">
      <h2>Select Series</h2>
      <button class="btn btn-primary" onclick="selectGameType(5)">5 Game Series</button>
      <button class="btn btn-primary" onclick="selectGameType(10)">10 Game Series</button>
      <button class="btn btn-secondary" onclick="goHome()">‚Üê Back</button>
    </div>
  </div>

  <!-- WINNER -->
  <div id="winnerScreen" class="screen" style="display:none">
    <div class="card">
      <h2>Who Won?</h2>
      <button class="btn btn-primary" onclick="selectTeam('winner','Bibin & Zach')">Bibin & Zach</button>
      <button class="btn btn-primary" onclick="selectTeam('winner','Bimal & Annu')">Bimal & Annu</button>
      <button class="btn btn-primary" onclick="selectTeam('winner','Bibin & Annu')">Bibin & Annu</button>
      <button class="btn btn-primary" onclick="selectTeam('winner','Zach & Daddy')">Zach & Daddy</button>
      <button class="btn btn-primary" onclick="selectTeam('winner','Bibin & Bimal')">Bibin & Bimal</button>
      <button class="btn btn-primary" onclick="selectTeam('winner','Zach & Rikku')">Zach & Rikku</button>
      <button class="btn btn-primary" onclick="selectTeam('winner','Bibin & Daddy')">Bibin & Daddy</button>
    </div>
  </div>

  <!-- LOSER -->
  <div id="loserScreen" class="screen" style="display:none">
    <div class="card">
      <h2>Who Lost?</h2>
      <button class="btn btn-secondary" onclick="selectTeam('loser','Bibin & Zach')">Bibin & Zach</button>
      <button class="btn btn-secondary" onclick="selectTeam('loser','Bimal & Annu')">Bimal & Annu</button>
      <button class="btn btn-secondary" onclick="selectTeam('loser','Bibin & Annu')">Bibin & Annu</button>
      <button class="btn btn-secondary" onclick="selectTeam('loser','Zach & Daddy')">Zach & Daddy</button>
      <button class="btn btn-secondary" onclick="selectTeam('loser','Bibin & Bimal')">Bibin & Bimal</button>
      <button class="btn btn-secondary" onclick="selectTeam('loser','Zach & Rikku')">Zach & Rikku</button>
      <button class="btn btn-secondary" onclick="selectTeam('loser','Bibin & Daddy')">Bibin & Daddy</button>
    </div>
  </div>

  <!-- STATS -->
  <div id="statsScreen" class="screen" style="display:none">
    <div class="card">
      <h2>Overall Statistics</h2>
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-top:10px">
        <div style="background:linear-gradient(135deg,#3affd0,#20a56e);padding:12px;border-radius:8px;text-align:center;font-weight:700;color:#07130f">
          <div>Total Games</div><div id="totalGames">0</div>
        </div>
        <div style="background:linear-gradient(135deg,#6ec0ff,#4a7bd6);padding:12px;border-radius:8px;text-align:center;font-weight:700;color:#07130f">
          <div>Total Teams</div><div id="totalSeries">0</div>
        </div>
      </div>
      <div id="teamStats" style="margin-top:12px"></div>
      <h3 style="margin-top:14px">Game History</h3>
      <div id="gameHistory"></div>
      <div style="margin-top:12px">
        <button class="btn btn-secondary" onclick="goHome()">‚Üê Back</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBdAIdEDwfoalevfadgixPTLIoLoEqi8kc",
    authDomain: "bluff-tracker-7542e.firebaseapp.com",
    projectId: "bluff-tracker-7542e",
    storageBucket: "bluff-tracker-7542e.firebasestorage.app",
    messagingSenderId: "280965687037",
    appId: "1:280965687037:web:be0b05da36ef653ab68094"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const gamesRef = collection(db, "games");

  console.log("üî• Firebase initialized");

  let gameData = { games: [], teamStats: {} };
  const STORAGE_KEY = 'bluff_tracker_v1';

  window.startNewGame = () => { window.currentGame = {}; showScreen('gameTypeScreen'); };
  window.selectGameType = t => { window.currentGame.gameType = t; showScreen('winnerScreen'); };

  window.selectTeam = async (role, team) => {
    if (role === 'winner') {
      window.currentGame.winner = team;
      showScreen('loserScreen');
      return;
    }

    if (!window.currentGame.winner) return alert('Pick winner first');
    if (team === window.currentGame.winner) return alert('Winner and loser cannot be same');

    window.currentGame.loser = team;
    const record = {
      winner: window.currentGame.winner,
      loser: window.currentGame.loser,
      series: window.currentGame.gameType,
      time: new Date().toISOString()
    };

    // Save locally first
    optimisticLocalSave(record);

    // Try Firebase, but never hang
    try {
      await Promise.race([
        addDoc(gamesRef, record),
        new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 2000))
      ]);
      console.log("‚òÅÔ∏è Uploaded to Firestore:", record);
    } catch (err) {
      console.warn("‚ö†Ô∏è Firebase save failed or timed out:", err);
    }

    alert(`‚úÖ ${record.winner} beat ${record.loser}`);
    showStats();
  };

  function optimisticLocalSave(r) {
    gameData.games.unshift(r);
    if (!gameData.teamStats[r.winner]) gameData.teamStats[r.winner] = { wins: 0, losses: 0 };
    if (!gameData.teamStats[r.loser]) gameData.teamStats[r.loser] = { wins: 0, losses: 0 };
    gameData.teamStats[r.winner].wins++;
    gameData.teamStats[r.loser].losses++;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(gameData));
    updateStatsUI();
  }

  onSnapshot(gamesRef, snapshot => {
    const docs = snapshot.docs.map(d => d.data());
    gameData.games = docs.sort((a, b) => new Date(b.time) - new Date(a.time));
    gameData.teamStats = {};
    docs.forEach(g => {
      if (!gameData.teamStats[g.winner]) gameData.teamStats[g.winner] = { wins: 0, losses: 0 };
      if (!gameData.teamStats[g.loser]) gameData.teamStats[g.loser] = { wins: 0, losses: 0 };
      gameData.teamStats[g.winner].wins++;
      gameData.teamStats[g.loser].losses++;
    });
    updateStatsUI();
  });

  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
    document.getElementById(id).style.display = 'block';
    document.getElementById('homeBtn').style.display = (id === 'homeScreen') ? 'none' : 'inline-block';
  }
  window.goHome = () => showScreen('homeScreen');
  window.showStats = () => { showScreen('statsScreen'); updateStatsUI(); };

  function updateStatsUI() {
    const total = gameData.games.length;
    document.getElementById('totalGames').textContent = total;
    document.getElementById('totalSeries').textContent = Object.keys(gameData.teamStats).length;
    const t = Object.keys(gameData.teamStats).sort((a, b) => (gameData.teamStats[b].wins || 0) - (gameData.teamStats[a].wins || 0));
    let html = '';
    t.forEach((team, i) => {
      const s = gameData.teamStats[team], w = s.wins || 0, l = s.losses || 0, total = w + l, wp = total ? Math.round((w / total) * 100) : 0, lp = 100 - wp;
      html += `<div class="team-item ${i === 0 ? 'champion-team' : ''}">
        <div class="team-name">${team}</div>
        <div class="metric-row">
          <div class="metric-box">Wins<br>${w}</div>
          <div class="metric-box">Losses<br>${l}</div>
          <div class="metric-box">Win %<br>${wp}</div>
        </div>
        <div class="bar-graph"><div class="bar-wins" style="width:${wp}%"></div><div class="bar-losses" style="width:${lp}%"></div></div>
      </div>`;
    });
    document.getElementById('teamStats').innerHTML = html || '<div style="color:#ccc">No teams yet</div>';
    const hist = gameData.games.map(g => `<div style="background:rgba(255,255,255,0.06);padding:10px;margin:8px 0;border-radius:10px;">
      <small>${new Date(g.time).toLocaleString()}</small><br><b>${g.winner}</b> beat <b>${g.loser}</b>
    </div>`).join('');
    document.getElementById('gameHistory').innerHTML = hist || '<div style="color:#ccc">No games yet</div>';
  }
</script>
</body>
</html>
