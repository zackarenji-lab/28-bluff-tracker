<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bluff Masters</title>
<link rel="icon" href="blufffavicon.png" />
<style>
  :root{
    --bg1:#061226;
    --bg2:#081b31;
    --card:#0e2336;
    --muted:#9fb7bf;
    --accent:#2ecc71;
    --gold:#ffd36d;
    --danger:#ff6b6b;
  }
  html,body{height:100%;margin:0;font-family:Inter,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:radial-gradient(circle at 10% 10%,var(--bg1),var(--bg2) 60%);color:#e6eef3;-webkit-font-smoothing:antialiased;}
  .wrap{max-width:1100px;margin:22px auto;padding:20px;}
  header{display:flex;align-items:center;gap:18px;margin-bottom:18px}
  .logo{width:62px;height:62px;border-radius:12px;background:linear-gradient(135deg,#ff6b6b,#ffd36d);display:flex;align-items:center;justify-content:center;font-weight:800;color:#07111a;box-shadow:0 8px 28px rgba(0,0,0,0.6)}
  h1{margin:0;font-size:28px}
  .subtitle{color:var(--muted);font-size:13px;margin-top:6px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.02)); border-radius:14px;padding:16px;box-shadow: 8px 8px 32px rgba(2,6,12,0.6), -6px -6px 18px rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.03);}
  .section-title{font-size:28px;margin:6px 0 12px}
  .small-muted{font-size:0.9rem;color:var(--muted)}
  #activeList{display:flex;flex-direction:column;gap:12px}
  .series-card{display:flex;justify-content:space-between;align-items:center;gap:12px;padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(0,0,0,0.02));border:1px solid rgba(255,255,255,0.02)}
  .series-card .left{flex:1}
  .series-card .title{font-weight:700;font-size:1.05rem}
  .series-card .sub{color:var(--muted);font-size:0.9rem;margin-top:6px}
  .right-controls{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;background:linear-gradient(90deg, rgba(255,208,96,0.02), rgba(255,208,96,0.005));border:1px solid rgba(255,208,96,0.04)}
  .score{font-weight:800;font-size:1.05rem;margin-right:6px;color:#e9f7f1;white-space:nowrap}
  .neu-btn{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.06));border-radius:10px;border:1px solid rgba(255,255,255,0.04);padding:10px 14px;color:#e6eef3;font-weight:700;cursor:pointer;transition:transform .12s ease,box-shadow .12s ease}
  .neu-btn.secondary{background:linear-gradient(180deg, rgba(0,0,0,0.06), rgba(255,255,255,0.01));color:#cfe3e3}
  .neu-btn:hover{transform:translateY(-3px);box-shadow:0 12px 30px rgba(0,0,0,0.5)}
  .trash{background:transparent;border:none;padding:8px;border-radius:8px;cursor:pointer;color:rgba(255,255,255,0.9);transition:transform .12s ease,box-shadow .12s ease}
  .trash:hover{transform:translateY(-3px);box-shadow:0 6px 18px rgba(255,80,80,0.25);color:var(--danger)}
  .champion-bar{margin-top:18px;padding:18px;border-radius:12px;background:linear-gradient(90deg,#3b2b03,#4b2f05);color:#fff;display:flex;align-items:center;gap:12px;position:relative;overflow:visible}
  .trophy{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#ffd36d,#ffb84d);display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 12px 40px rgba(255,200,80,0.12)}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.65);display:flex;align-items:center;justify-content:center;z-index:9999}
  .confirm-box{background:#0b1622;padding:22px;border-radius:12px;color:#e6eef3;max-width:520px;width:92%;box-shadow:0 12px 60px rgba(2,6,12,0.7);border:1px solid rgba(255,255,255,0.04)}
  .celebration-layer{position:fixed;inset:0;z-index:9998;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0;transition:opacity .45s ease;background:rgba(255,255,255,0.06);backdrop-filter: blur(6px);}
  .celebration-inner{position:relative;width:100%;height:100%}
  .celebration-embed{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0.95}
  .celebration-modal{position:relative;z-index:10001;pointer-events:auto;max-width:720px;margin:auto}
  .celebration-text{background:rgba(3,6,10,0.6);padding:18px;border-radius:12px;color:#fff;text-align:center;backdrop-filter:blur(4px);box-shadow:0 12px 40px rgba(0,0,0,0.6)}
  canvas#fireworks{position:fixed;left:0;top:0;width:100%;height:100%;z-index:9997;pointer-events:none;display:none}
  @media (max-width:760px){ .right-controls{flex-direction:row; flex-wrap:wrap; justify-content:center} }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="logo">28</div>
    <div>
      <h1>Bluff Masters</h1>
      <div class="subtitle">Track multiple active series, shared stats & celebrations</div>
    </div>
    <div style="flex:1"></div>
    <div style="text-align:right">
      <button class="neu-btn" onclick="goHome()">üè† Home</button>
    </div>
  </header>

  <section id="homeSection">
    <div class="card hero">
      <img src="bluffmasters.png" alt="Bluff Masters" style="width:100%;border-radius:10px;display:block;margin-bottom:14px" onerror="console.warn('bluffmasters.png missing')"/>
      <div class="active-wrap card" style="margin-top:12px">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <div class="section-title">Active Series</div>
            <div class="small-muted" id="noActive">No Active Series ‚Äî start a new one.</div>
            <div style="color:#cfeee6;margin-top:8px" id="seriesCount">Series Active: 0</div>
          </div>
          <div style="display:flex;gap:12px;align-items:center">
            <button class="neu-btn" onclick="startNewSeries()">‚ûï New Series</button>
            <button class="neu-btn secondary" onclick="showStats()">üìä View Statistics</button>
          </div>
        </div>
        <div id="activeList" style="margin-top:14px"></div>
      </div>
      <div class="champion-bar" style="margin-top:18px">
        <div class="trophy">üèÜ</div>
        <div style="font-weight:800;font-size:1.05rem">Current Champions : <span id="championText" style="margin-left:8px;color:#fff">‚Äî</span></div>
      </div>
    </div>
  </section>

  <section id="statsSection" class="card" style="margin-top:18px;display:none"></section>
</div>

<div id="celebrationLayer" class="celebration-layer" aria-hidden="true">
  <div class="celebration-inner">
    <div id="celebrationEmbed" class="celebration-embed"></div>
    <div class="celebration-modal" id="celebrationModalContainer"></div>
  </div>
</div>

<div id="modalContainer"></div>
<canvas id="fireworks"></canvas>
<script type="text/javascript" async src="https://tenor.com/embed.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, getDocs, deleteDoc, limit, where, updateDoc } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

const FIREBASE_CONF = { apiKey: "AIzaSyBdAIdEDwfoalevfadgixPTLIoLoEqi8kc", authDomain: "bluff-tracker-7542e.firebaseapp.com", projectId: "bluff-tracker-7542e", storageBucket: "bluff-tracker-7542e.appspot.com", messagingSenderId: "280965687037", appId: "1:280965687037:web:be0b05da36ef653ab68094" };
const SECRET_KEY = "zachariahrenji";
const STORAGE_KEY = "bluff_tracker_v1";
const TEAM_LIST = ["Bibin & Zach","Bimal & Annu","Bibin & Annu","Zach & Daddy","Bibin & Bimal","Zach & Rikku","Bibin & Daddy"];

let db=null, gamesRef=null;
try { const app = initializeApp(FIREBASE_CONF); db = getFirestore(app); gamesRef = collection(db, "games"); } catch(e){ console.warn(e); }

let gameData = { games: [] };
(function loadLocal(){ try{ const raw = localStorage.getItem(STORAGE_KEY); if(raw) gameData = JSON.parse(raw); }catch(e){}})();
function saveLocal(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(gameData)); }catch(e){}}

function uid(prefix="s"){ return prefix + "_" + Date.now() + "_" + Math.floor(Math.random()*9000+1000); }
function escapeHtml(s){ if(!s) return ""; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]); }

async function cloudSaveGame(rec){ if(!gamesRef) return; try{ await addDoc(gamesRef, {...rec, secret: SECRET_KEY}); }catch(e){}}

function computeAggregates(){
  const seriesMap = {};
  const teamStats = {};
  (gameData.games||[]).forEach(g=>{
    const sid = g.seriesId;
    if(!seriesMap[sid]) seriesMap[sid] = { id:sid, target: g.seriesTarget||5, games: [], wins: {}, finished:false, winner:null, isRandom: false, startedAt: g.seriesStartedAt || g.time || new Date().toISOString() };
    const s = seriesMap[sid];
    
    if (g.type === "MANUAL_END") {
        s.finished = true;
        s.winner = g.winner;
        s.isRandom = true;
    } else {
        s.games.push(g);
        if(g.winner) {
            s.wins[g.winner] = (s.wins[g.winner] || 0) + 1;
            teamStats[g.winner] = teamStats[g.winner] || { wins:0, losses:0, seriesWon:0 };
            teamStats[g.loser] = teamStats[g.loser] || { wins:0, losses:0, seriesWon:0 };
            teamStats[g.winner].wins++;
            teamStats[g.loser].losses++;
        }
    }
  });

  Object.values(seriesMap).forEach(s=>{
    Object.keys(s.wins).forEach(t=>{ if(s.wins[t] >= s.target && !s.finished){ s.finished = true; s.winner = t; s.isRandom = false; } });
    if(s.finished && s.winner) {
        teamStats[s.winner] = teamStats[s.winner] || { wins:0, losses:0, seriesWon:0 };
        teamStats[s.winner].seriesWon++;
    }
  });

  const activeSeries = Object.values(seriesMap).filter(s=>!s.finished).sort((a,b)=> new Date(b.startedAt) - new Date(a.startedAt));
  const completedByTarget = {5:0, 10:0, random:0};
  Object.values(seriesMap).filter(s=>s.finished).forEach(s=>{
      if(s.isRandom) completedByTarget.random++;
      else if(s.target === 5) completedByTarget[5]++;
      else if(s.target === 10) completedByTarget[10]++;
  });

  return { seriesMap, teamStats, activeSeries, completedByTarget };
}

function renderHomeActiveList(){
  const { activeSeries } = computeAggregates();
  const container = document.getElementById("activeList");
  if(!container) return;
  container.innerHTML = "";
  document.getElementById("noActive").style.display = (activeSeries.length === 0) ? "block" : "none";
  document.getElementById("seriesCount").textContent = "Series Active: " + activeSeries.length;

  activeSeries.forEach(s=>{
    const names = Array.from(new Set(s.games.flatMap(g=>[g.winner,g.loser]))).slice(0,2);
    const tA = names[0] || TEAM_LIST[0];
    const tB = names[1] || TEAM_LIST[1];
    const sA = s.wins[tA] || 0;
    const sB = s.wins[tB] || 0;

    const card = document.createElement("div");
    card.className = "series-card";
    card.innerHTML = `
      <div class="left">
        <div class="title">${escapeHtml(tA)} vs ${escapeHtml(tB)}</div>
        <div class="sub">First to ${s.target} ‚Ä¢ started ${new Date(s.startedAt).toLocaleString()}</div>
      </div>
      <div class="right-controls">
        <div class="score">${sA > sB ? 'üëë ' : ''}${sA} ‚Äî ${sB}${sB > sA ? ' üëë' : ''}</div>
        <button class="neu-btn" onclick="openAddGame('${s.id}')">‚ûï Add</button>
        <button class="neu-btn secondary" onclick="viewSeriesDetails('${s.id}')">Details</button>
        <button class="neu-btn" style="background:var(--danger); color:white" onclick="manualEndGame('${s.id}')">‚èπ End</button>
        <button class="trash" onclick="deleteSeriesConfirm('${s.id}')">üóë</button>
      </div>`;
    container.appendChild(card);
  });
  updateChampionBar();
}

window.manualEndGame = function(seriesId) {
    const { seriesMap } = computeAggregates();
    const s = seriesMap[seriesId];
    const teams = Object.keys(s.wins);
    if(teams.length < 1) return alert("No games played yet.");
    const tA = teams[0], tB = teams[1] || "Opponent";
    const sA = s.wins[tA] || 0, sB = s.wins[tB] || 0;
    if(sA === sB) return alert("Score is tied! Play one more to break the tie.");
    const winner = sA > sB ? tA : tB;
    if(!confirm(`End series now? ${winner} wins ${sA}-${sB}`)) return;
    const rec = { seriesId, type: "MANUAL_END", winner, loser: (winner===tA?tB:tA), time: new Date().toISOString() };
    gameData.games.push(rec); saveLocal(); cloudSaveGame(rec);
    showWinnerCelebration(winner, Math.max(sA,sB), Math.min(sA,sB));
    renderHomeActiveList();
};

window.startNewSeries = function(){
  const opts = TEAM_LIST.map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");
  const inner = `<div>Target: <select id="mTarget"><option value="5">5</option><option value="10">10</option></select></div>
                 <div style="margin-top:10px">Team A: <select id="mTeamA" onchange="filterTeams()">${opts}</select></div>
                 <div style="margin-top:10px">Team B: <select id="mTeamB">${opts}</select></div>`;
  showModalBox("New Series", inner, "Start", () => {
    const target = parseInt(document.getElementById("mTarget").value);
    const tA = document.getElementById("mTeamA").value, tB = document.getElementById("mTeamB").value;
    if(tA === tB) return alert("Teams must be different!");
    const rec = { seriesId: uid("series"), seriesTarget: target, time: new Date().toISOString(), type: "INIT", winner: tA, loser: tB };
    gameData.games.push(rec); saveLocal(); cloudSaveGame(rec); renderHomeActiveList();
  });
  window.filterTeams = () => {
      const a = document.getElementById("mTeamA").value, b = document.getElementById("mTeamB");
      Array.from(b.options).forEach(o => o.disabled = (o.value === a));
      if(b.value === a) b.value = TEAM_LIST.find(t => t !== a);
  };
  setTimeout(filterTeams, 100);
};

/* Core logic from original remains untouched below */
window.openAddGame = function(seriesId){
  const { seriesMap } = computeAggregates();
  const s = seriesMap[seriesId];
  const names = Array.from(new Set(s.games.flatMap(g=>[g.winner,g.loser]))).filter(x=>x && x!=="INIT").slice(0,2);
  const tA = names[0] || TEAM_LIST[0], tB = names[1] || TEAM_LIST[1];
  const inner = `<div style="display:flex; gap:10px; justify-content:center">
                 <button class="neu-btn" onclick="addG('${seriesId}','${tA}','${tB}')">${tA} won</button>
                 <button class="neu-btn" onclick="addG('${seriesId}','${tB}','${tA}')">${tB} won</button></div>`;
  showModalBox("Who won?", inner, "Cancel");
};
window.addG = (sid, w, l) => {
    const { seriesMap } = computeAggregates();
    const s = seriesMap[sid];
    const rec = { winner: w, loser: l, seriesId: sid, seriesTarget: s.target, time: new Date().toISOString() };
    gameData.games.push(rec); saveLocal(); cloudSaveGame(rec); closeModal();
    const updated = computeAggregates().seriesMap[sid];
    if(updated.finished) showWinnerCelebration(w, updated.wins[w], (updated.wins[l]||0));
    renderHomeActiveList();
};

function showWinnerCelebration(name, sW, sL){
  const layer = document.getElementById("celebrationLayer"), embed = document.getElementById("celebrationEmbed"), cont = document.getElementById("celebrationModalContainer");
  embed.innerHTML = `<div class="tenor-gif-embed" data-postid="22069448" data-share-method="host" data-aspect-ratio="1" data-width="100%"><a href="https://tenor.com/view/winner-gif-22069448">Winner GIF</a></div>`;
  cont.innerHTML = `<div class="celebration-text"><h2>üéâ ${escapeHtml(name)} Won!</h2><p>Score: ${sW} - ${sL}</p><button class="neu-btn" onclick="closeWinnerCelebration()">OK</button></div>`;
  layer.style.opacity = "1"; layer.setAttribute("aria-hidden", "false");
  startFireworks(3000); if(window.Tenor) window.Tenor.refresh();
  setTimeout(closeWinnerCelebration, 5000);
}
window.closeWinnerCelebration = () => { document.getElementById("celebrationLayer").style.opacity = "0"; };

function updateStatsUI(){
  const { teamStats, completedByTarget } = computeAggregates();
  const sorted = Object.keys(teamStats).sort((a,b)=> teamStats[b].wins - teamStats[a].wins);
  const hist = (gameData.games||[]).slice().reverse().map(g=> g.winner ? `<div style="padding:5px; border-bottom:1px solid #222">${g.winner} beat ${g.loser}</div>` :
